// === Climbing Formation Popup - ESRI Arcade Compatible Version ===

// --- Fields ---
var featureName  = IIf(IsEmpty($feature.FEATURE), "Unnamed Formation", Text($feature.FEATURE));
var routes       = IIf(IsEmpty($feature.ROUTES), "", Text($feature.ROUTES));
var permitReq    = IIf(IsEmpty($feature.PERMITREQ), "No", Text($feature.PERMITREQ));
var hca          = IIf(IsEmpty($feature.HCA), "No", Text($feature.HCA));
var formationType= IIf(IsEmpty($feature.FormationType), "", Text($feature.FormationType));
var owner        = IIf(IsEmpty($feature.OWNER), "", Text($feature.OWNER));
var seasonal     = IIf(IsEmpty($feature.SeasonalClosure), "NO", Upper(Text($feature.SeasonalClosure)));
var areaAccess   = IIf(IsEmpty($feature.AreaAccess), "", Text($feature.AreaAccess));
var useRatingNum = IIf(IsEmpty($feature.UseRating), Null, $feature.UseRating);
var useRating    = IIf(IsEmpty(useRatingNum), "", Text(Round(useRatingNum, 2)));
var closureActive= IIf(IsEmpty($feature.ClosureActive), "N", Text($feature.ClosureActive));
var displayFlag  = IIf(IsEmpty($feature.Display), "Yes", Text($feature.Display));
var fixedHardware= IIf(IsEmpty($feature.FixedHardwarePermit), "No", Text($feature.FixedHardwarePermit));

// --- Status color ---
var statusColor = IIf(Upper(closureActive) == "Y", "#772618", "#27443A");

// --- Icon URLs ---
var urlClimbYes     = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/ClimbingYes.svg";
var urlClimbNo      = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/ClimbingNo.svg";
var urlRockYes      = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/RockClimbingYes.svg";
var urlRockNo       = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/RockClimbingNo.svg";
var urlPass         = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Pass.svg";
var urlHcaPass      = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/HCA3.svg";
var urlDiffEasy     = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/DifficultyEasy.svg";
var urlDiffMed      = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/DifficultyMedium.svg";
var urlDiffHard     = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/DifficultyHard.svg";
var urlDiffVeryHard = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/DifficultyVeryHard.svg";
var urlCalendar     = "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Calendar.svg";
var urlOSMPLogo     = "https://boulder.maps.arcgis.com/sharing/rest/content/items/5739adf1962d4b44a0be659b2790fe74/data";

// --- Logic for allowed activities ---
var climbingAllowed = IIf(Find("NO CLIMB", Upper(areaAccess)) > -1 || Upper(displayFlag) == "NO" || Upper(closureActive) == "Y", false, true);
var ftUpper = Upper(formationType);
var isBoulder = IIf(Find("BOULDER", ftUpper) > -1, true, false);
var isWall = IIf(Find("WALL", ftUpper) > -1, true, false);

// --- Unified icon size ---
var iconSize = 30;

function makeIcon(u, alt){
    return '<img src="' + u + '" alt="' + alt + '" title="' + alt + '" width="' + iconSize + '" height="' + iconSize + '" style="margin:0 6px;object-fit:contain;">';
}

// --- Difficulty icons ---
var diffIcon = "";
if (!IsEmpty(useRatingNum)) {
    if (useRatingNum <= 2) {
        diffIcon = makeIcon(urlDiffEasy, "Difficulty: Easy");
    } else if (useRatingNum <= 3.5) {
        diffIcon = makeIcon(urlDiffMed, "Difficulty: Medium");
    } else if (useRatingNum <= 4.5) {
        diffIcon = makeIcon(urlDiffHard, "Difficulty: Hard");
    } else {
        diffIcon = makeIcon(urlDiffVeryHard, "Difficulty: Very Hard");
    }
}

// --- Seasonal / Active closure ---
var closureBlock = "";
var hasClosure = false;
if (Upper(seasonal) == "YES" || Upper(closureActive) == "Y") {
    hasClosure = true;
    closureBlock = '<p>' + makeIcon(urlCalendar, "Seasonal Closure") + '&nbsp;&nbsp;' +
        '<span style="font-family:Arial;font-size:14px;color:#aa2525;"><strong>Seasonal / Active Closure</strong>' +
        IIf(Upper(seasonal) == "YES", ': Seasonal closure in effect.', '') +
        IIf(Upper(closureActive) == "Y", ' This formation is currently closed.', '') +
        ' See <a href="https://bouldercolorado.gov/services/osmp-closures" target="_blank" rel="nofollow" style="color:#aa2525;text-decoration:underline;">OSMP\'s Closure Webpage</a>.' +
        '</span>' +
        '</p>';
}

// --- Build HTML ---
var html = '';
html += '<h3 style="background-color:' + statusColor + ';border:1px solid #000;color:white;padding:5px;text-align:center;">' + featureName + '</h3>';

// --- Owner block ---
var owner = Text($feature.OWNER);
var ownerHtml = "";
var osmpIconHtml = "";

if (IsEmpty(owner)) {
    ownerHtml = '<div style="text-align:left;"><b>Owner:</b> Unknown</div>';
} else if (Upper(owner) == "OSMP") {
    // Icon centered, text below left aligned with bold label
    osmpIconHtml = '<div style="text-align:center;">' + makeIcon(urlOSMPLogo, "OSMP") + '</div>';
    ownerHtml = '<p style="text-align:left;"><b>Owner:</b> ' + owner + '</p>';
} else {
    // Non-OSMP owner, no icon
    ownerHtml = '<p style="text-align:left;"><b>Owner:</b> ' + owner + '</p>';
}

// Append to HTML
html += osmpIconHtml + ownerHtml;
html += '<p><strong>Access Notes:</strong> ' + IIf(IsEmpty(areaAccess), 'N/A', areaAccess) + '</p>';

// --- Closure info ---
html += closureBlock;

// --- Only show general closure link if no seasonal/active closure ---
if (!hasClosure) {
    html += '<p>For closures and management info see <a href="https://bouldercolorado.gov/services/osmp-closures" target="_blank" rel="nofollow">OSMP\'s Closure Webpage</a></p>';
}

// --- Allowed / Not Allowed Activities header ---
var activityHeaderColor = statusColor; // use the same status color
var activityHeaderText  = IIf(Upper(closureActive) == "Y", "Not Allowed Activities", "Allowed Activities");
html += '<h3 style="background-color:' + activityHeaderColor + ';border:1px solid #000;color:white;padding:5px;text-align:center;">' + activityHeaderText + '</h3>';

// --- Activity icons ---
var activityIcons = "";
if (isWall) {
    activityIcons = IIf(climbingAllowed, makeIcon(urlRockYes, 'Rock Climbing Allowed'), makeIcon(urlRockNo, 'Rock Climbing Not Allowed'));
} else if (isBoulder) {
    activityIcons = IIf(climbingAllowed, makeIcon(urlClimbYes, 'Climbing Allowed'), makeIcon(urlClimbNo, 'Climbing Not Allowed'));
} else {
    activityIcons = IIf(climbingAllowed, makeIcon(urlClimbYes, 'Climbing Allowed'), makeIcon(urlClimbNo, 'Climbing Not Allowed')) +
                    IIf(climbingAllowed, makeIcon(urlRockYes, 'Rock Climbing Allowed'), makeIcon(urlRockNo, 'Rock Climbing Not Allowed'));
}

html += '<p style="text-align:center;">' + activityIcons + '</p>';
html += '<p><strong>Type:</strong> ' + formationType + '</p>';

// --- Passes & Permits ---
html += '<h3 style="background-color:#27443A;border:1px solid #000;color:white;padding:5px;text-align:center;">Passes & Permits</h3>';
var permitsNeeded = false;
if (Upper(hca) == 'YES') {
    html += '<p>' + makeIcon(urlHcaPass, 'HCA Pass Required') + ' HCA pass required for this location. <a href="https://bouldercolorado.gov/services/off-trail-permits" target="_blank" rel="nofollow" style="text-decoration:underline;">Apply for an Off-Trail Permit</a></p>';
    permitsNeeded = true;
}
if (Upper(fixedHardware) == 'YES') {
    html += '<p>' + makeIcon(urlPass, 'Fixed Hardware Permit Required') + ' Fixed hardware permit is required. <a href="http://flatironsclimbing.org/fixed-hardware-application-process/" target="_blank" rel="nofollow" style="text-decoration:underline;">Apply for Fixed Hardware Permit</a></p>';
    permitsNeeded = true;
}
if (!permitsNeeded) {
    html += '<p style="text-align:center;color:#666;">No permits or passes required</p>';
}

// --- Hazards & Difficulty ---
html += '<h3 style="background-color:#27443A;border:1px solid #000;color:white;padding:5px;text-align:center;">Hazards & Difficulty</h3>';
html += '<p style="text-align:center;">' + diffIcon + '</p>'; // corrected variable
html += '<p><strong>Routes:</strong> ' + IIf(IsEmpty(routes), 'Unknown', routes) + '</p>';
html += '<p><strong>Use Rating:</strong> ' + IIf(IsEmpty(useRating), 'N/A', useRating) + '</p>';

// --- Return final HTML ---
return { 
    type : 'text', 
    text : html // this property supports HTML tags
};
