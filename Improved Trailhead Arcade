var horses   = $feature['OSMP.TrailsOSMP.HORSES'] == "Yes";
var bikes    = $feature['OSMP.TrailsOSMP.BICYCLES'] == "Yes";
var ebikes   = $feature['OSMP.TrailsOSMP.EBIKES'] == "Yes";
var dogs     = $feature['OSMP.TrailsOSMP.DOGS'] == "Yes";

var status   = $feature["OSMP.TrailClosures.TRAILSTATUS"];
var reason   = $feature["OSMP.TrailClosures.CLOSUREREASON"];
var duration = $feature["OSMP.TrailClosures.CLOSUREDURATION"];
var contact  = $feature["OSMP.TrailClosures.CONTACT"];
var comments = $feature["OSMP.TrailClosures.COMMENTS"];
var trlid    = $feature["OSMP.TrailsOSMP.TRLID"];
var name     = $feature["OSMP.TrailsOSMP.TRAILNAME"];
var miles    = $feature["OSMP.TrailsOSMP.MILEAGE"];
var diff     = $feature["OSMP.TrailsOSMP.DIFFICULTY"];

// === Status color ===
var statusColor = IIf(status == "Open", "#28563a", "#aa2525");

// === Allowed use icons with spacing + hover text ===
var hikeIcon = '<img src="https://maps.bouldercounty.org/icons/POS/trails/hike.svg" alt="Hiking Allowed" title="Hiking Allowed" width="30" height="30" style="margin:0 5px;">';

var bikeIcon = '<img src="' + 
    IIf(bikes, "https://maps.bouldercounty.org/icons/POS/trails/bike.svg", "https://maps.bouldercounty.org/icons/POS/trails/nobike.svg") +
    '" alt="' + IIf(bikes, "Traditional Bikes Allowed", "No Bikes Allowed") +
    '" title="' + IIf(bikes, "Traditional Bikes Allowed", "No Bikes Allowed") +
    '" width="30" height="30" style="margin:0 1px;">';

var ebikeIcon = '<img src="' +
    IIf(ebikes, "https://maps.bouldercolorado.gov/websites/osmp/images/EbikeYes.svg", "https://maps.bouldercolorado.gov/websites/osmp/images/EbikeNo.svg") +
    '" alt="' + IIf(ebikes, "E-Bikes Allowed", "No E-Bikes Allowed") +
    '" title="' + IIf(ebikes, "E-Bikes Allowed", "No E-Bikes Allowed") +
    '" width="30" height="30" style="margin:0 1px;">';

var horseIcon = '<img src="' +
    IIf(horses, "https://maps.bouldercounty.org/icons/POS/trails/horse.svg", "https://maps.bouldercounty.org/icons/POS/trails/nohorse.svg") +
    '" alt="' + IIf(horses, "Horse Allowed", "Horse Not Allowed") +
    '" title="' + IIf(horses, "Horse Allowed", "Horse Not Allowed") +
    '" width="30" height="30" style="margin:0 1px;">';

var dogIcon = '<img src="' +
    IIf(dogs, "https://maps.bouldercounty.org/icons/POS/trails/dog.svg", "https://maps.bouldercounty.org/icons/POS/trails/nodog.svg") +
    '" alt="' + IIf(dogs, "Dogs Allowed", "No Dogs Allowed") +
    '" title="' + IIf(dogs, "Dogs Allowed", "No Dogs Allowed") +
    '" width="30" height="30" style="margin:0 1px;">';

// === Voice and Sight icon ===
var vsIconUrl = When(
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "LVS M-F, Leash Required Sat & Sun", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VSMF.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VSNo.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required on Portion of Trail", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/PartialVS.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required on South Portion", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/PartialVS.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash, Or Voice and Sight Control", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VS.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "No Dogs", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VSNo.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "On-Corridor Voice and Sight", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VSC.svg",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Regulation Varies", "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/PartialVS.svg",
    "https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VSNo.svg"
);

var vsAltText = When(
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "LVS M-F, Leash Required Sat & Sun", "Leash, Or Voice and Sight Control for dogs with tag on weekdays, Leash on weekends.",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required", "Leash required by all dogs.",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required on Portion of Trail", "Leash Required on Portion of Trail.",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash Required on South Portion", "Leash Required on Portion of Trail",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Leash, Or Voice and Sight Control", "Leash, Or Voice and Sight Control for dogs with tag.",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "No Dogs", "No Dogs",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "On-Corridor Voice and Sight", "Leash, Or Voice and Sight Control within 20ft of trail for dogs with tag.",
    $feature['OSMP.TrailsOSMP.DOGREGDESC'] == "Regulation Varies", "Leash Required on Portion of Trail",
    "No Dogs"
);

var vsIcon = '<img src="' + vsIconUrl + '" alt="' + vsAltText + '" title="' + vsAltText + '" width="30" height="30" style="margin:0 1px;">';

// === Closure text blocks (only if Closed) ===
var closureText = "";
if (status == "Closed") {
    closureText += '<span style="font-family:Arial;font-size:18px;"><strong><br><br>Closure Reason: </strong>' + reason + '</span>';
    closureText += '<span style="font-family:Arial;font-size:18px;"><strong><br><br>Closure Duration: </strong>' + duration + '</span>';
    if (!IsEmpty(comments)) {
        closureText += '<span style="font-family:Arial;font-size:18px;"><strong><br><br>Comments: </strong>' + comments + '</span>';
    }
    if (!IsEmpty(contact)) {
        closureText += '<span style="font-family:Arial;font-size:18px;"><strong><br><br>More Info: </strong><a href="' + contact + '" target="_blank" style="color:#406f8c;">OSMP Closures</a></span>';
    }
}

// === Build HTML ===
var html = ''
+ '<h3 style="background-color:#27443A;border-style:solid;border-width:1px;color:white;padding:5px;text-align:center;">'
+ '<span style="font-family:Arial;font-size:18px;">' + name + ' Trail Info</span>'
+ '</h3>'

+ '<p><span style="font-family:Arial;font-size:18px;"><strong>Trail Status:</strong></span> '
+ '<span style="font-family:Arial;font-size:18px;"><font color="' + statusColor + '"><strong>' + status + '</strong></font></span>'
+ '</p>'

+ closureText

+ '<p><span style="font-family:Arial;font-size:18px;"><strong>Length:</strong></span> '
+ '<span style="font-family:Arial;font-size:18px;">' + miles + ' mi</span></p>'

+ '<p><span style="font-family:Arial;font-size:18px;"><strong>Difficulty:</strong></span> '
+ '<span style="font-family:Arial;font-size:18px;">' + diff + '</span></p>'

+ '<h3 style="background-color:#27443A;border-style:solid;border-width:1px;color:white;padding:5px;text-align:center;">'
+ '<span style="font-family:Arial;font-size:18px;">Allowed Uses</span>'
+ '</h3>'

+ '<p style="text-align:center;">' + hikeIcon + bikeIcon + ebikeIcon + horseIcon + dogIcon + vsIcon + '</p>';

return html;
