// === OSMP Trailhead Popup - Full Consolidated Expression ===

// Feature attributes
var accessName = $feature['OSMP.TrailHeadsOSMP.ACCESSNAME'];
var parkSpaces = $feature['OSMP.TrailHeadsOSMP.PARKSPACES'];
var horseTrailer = $feature['OSMP.TrailHeadsOSMP.HORSETRAILERPARKING'];
var restrooms = $feature['OSMP.TrailHeadsOSMP.RESTROOMS'];
var bikeSpaces = $feature['OSMP.TrailHeadsOSMP.BIKESPACES'];
var trashCans = $feature['OSMP.TrailHeadsOSMP.TRASHCANS'];
var picnic = $feature['OSMP.TrailHeadsOSMP.PICNIC'];
var fishing = $feature['OSMP.TrailHeadsOSMP.FISHING'];
var recycling = $feature['OSMP.TrailHeadsOSMP.RECYCLEBIN'];
var camping = $feature['OSMP.TrailHeadsOSMP.CAMPING'];
var fee = $feature['OSMP.TrailHeadsOSMP.FEE'];
var thUrl = $feature['OSMP.TrailHeadsOSMP.THURL'];
var thCamera = $feature['OSMP.TrailHeadsOSMP.THCAMERA'];
var adaFacName = $feature['OSMP.TrailHeadsOSMP.ADAFACNAME'];

// Trailhead closure info
var trailheadStatus = $feature['OSMP.TrailheadClosures.TRAILHEADSTATUS'];
var closureReason = $feature['OSMP.TrailheadClosures.CLOSUREREASON'];
var closureDuration = $feature['OSMP.TrailheadClosures.CLOSUREDURATION'];
var closureContact = $feature['OSMP.TrailheadClosures.CONTACT'];

// === Helper: Horse trailer icon ===
function getHorseTrailerIcon(value) {
    var val = When(IsEmpty(value), "", Upper(Text(value)));
    if (Left(val, 10) == "DESIGNATED" || Left(val, 4) == "PULL") {
        return "https://bouldercolorado.gov/media/18179/download?inline";
    } else if (val == "NOT RECOMMENDED" || val == "POSSIBLE") {
        return "https://bouldercolorado.gov/media/18177/download?inline";
    } else {
        return "https://bouldercolorado.gov/media/18178/download?inline";
    }
}

// === Helper: Parking text ===
function getParkingText(spaces) {
    return When(
        spaces == 0, " are no parking spaces",
        spaces == 1, " is a large parking lot",
        spaces > 1, " are " + spaces + " parking spaces",
        " are no parking spaces"
    );
}

// === Helper: Parking icon ===
function getParkingIcon(spaces) {
    return IIf(spaces > 0, 
        "https://bouldercolorado.gov/media/18183/download?inline", 
        "https://bouldercolorado.gov/media/18182/download?inline");
}

// === Status color ===
var statusColor = IIf(trailheadStatus == "Open", "#27443A", "#772618");

// === Fee section ===
var feeSection = IIf(fee == "Yes",
    ' <a href="https://bouldercolorado.gov/services/osmp-parking-permits-and-fees" target="_blank" rel="nofollow">All park visitors whose motor vehicles are not registered in Boulder County must possess either a daily or annual permit to park.</a>',
    ''
);

// === Closure link ===
var closureLink = IIf(trailheadStatus == "Closed",
    '<p><a target="_blank" rel="nofollow" href="https://bouldercolorado.gov/services/osmp-closures">OSMP Closures Website</a></p>',
    ''
);

// === Camera link ===
var cameraLink = IIf(thCamera == "Yes",
    '<p><a target="_blank" rel="nofollow" href="https://bouldercolorado.gov/trailhead-cameras"><span style="font-family:Arial;font-size:14px;">OSMP Trailhead Cameras</span></a></p>',
    ''
);

// === Build Available / Not Available amenities ===
var availableAmenities = '';
var notAvailableAmenities = '';

// Restrooms
var restroomIcon = '<img src="https://bouldercolorado.gov/media/18176/download?inline" alt="Vault toilet available" title="Vault toilet available" width="30" height="30" style="margin:0 6px;">';
var noRestroomIcon = '<img src="https://bouldercolorado.gov/media/18175/download?inline" alt="No vault toilet available" title="No vault toilet available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(restrooms=="Yes", restroomIcon, notAvailableAmenities += noRestroomIcon);

// Bike Rack
var bikeRackIcon = '<img src="https://bouldercolorado.gov/media/18160/download?inline" alt="Bike parking available" title="Bike parking available" width="30" height="30" style="margin:0 6px;">';
var noBikeRackIcon = '<img src="https://bouldercolorado.gov/media/18161/download?inline" alt="No bike parking available" title="No bike parking available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(bikeSpaces>0, bikeRackIcon, notAvailableAmenities += noBikeRackIcon);

// Trash
var trashIcon = '<img src="https://bouldercolorado.gov/media/18181/download?inline" alt="Trash can available" title="Trash can available" width="30" height="30" style="margin:0 6px;">';
var noTrashIcon = '<img src="https://bouldercolorado.gov/media/18180/download?inline" alt="No trash can available" title="No trash can available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(trashCans>0, trashIcon, notAvailableAmenities += noTrashIcon);

// Picnic
var picnicIcon = '<img src="https://bouldercolorado.gov/media/18171/download?inline" alt="Picnic area available" title="Picnic area available" width="30" height="30" style="margin:0 6px;">';
var noPicnicIcon = '<img src="https://bouldercolorado.gov/media/18170/download?inline" alt="No picnic area available" title="No picnic area available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(picnic=="Yes", picnicIcon, notAvailableAmenities += noPicnicIcon);

// Fishing
var fishingIcon = '<img src="https://bouldercolorado.gov/media/18168/download?inline" alt="Access to fishing" title="Access to fishing" width="30" height="30" style="margin:0 6px;">';
var noFishingIcon = '<img src="https://bouldercolorado.gov/media/18167/download?inline" alt="No access to fishing" title="No access to fishing" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(fishing=="Yes", fishingIcon, notAvailableAmenities += noFishingIcon);

// Recycling
var recyclingIcon = '<img src="https://bouldercolorado.gov/media/18174/download?inline" alt="Recycling available" title="Recycling available" width="30" height="30" style="margin:0 6px;">';
var noRecyclingIcon = '<img src="https://bouldercolorado.gov/media/18173/download?inline" alt="No recycling available" title="No recycling available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(recycling=="Yes", recyclingIcon, notAvailableAmenities += noRecyclingIcon);

// Camera
var cameraIcon = '<img src="https://bouldercolorado.gov/media/18163/download?inline" alt="Trailhead camera available" title="Trailhead camera available" width="30" height="30" style="margin:0 6px;">';
var noCameraIcon = '<img src="https://bouldercolorado.gov/media/18162/download?inline" alt="No trailhead camera available" title="No trailhead camera available" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(thCamera=="Yes", cameraIcon, notAvailableAmenities += noCameraIcon);

// Camping
var campingIcon = '<img src="https://bouldercolorado.gov/media/18165/download?inline" alt="Camping allowed" title="Camping allowed" width="30" height="30" style="margin:0 6px;">';
var noCampingIcon = '<img src="https://bouldercolorado.gov/media/18164/download?inline" alt="No camping allowed" title="No camping allowed" width="30" height="30" style="margin:0 6px;">';
availableAmenities += IIf(camping=="Yes", campingIcon, notAvailableAmenities += noCampingIcon);

// === ADA Facility Icons and Alt Text ===
var adaIconHtml = ""; // HTML string for icons
var adaAltText = "";

if (!IsEmpty(adaFacName)) {
    if (adaFacName == "Cherryvale Offices") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/RangerBadge.svg" alt="Cherryvale Ranger Offices" title="Cherryvale Ranger Offices" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Cherryvale Ranger Offices";
    } 
    else if (adaFacName == "Dock/Shelter/Bird Blind") {
        // Multiple icons concatenated
        adaIconHtml = 
            '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/FishingPier.svg" alt="Fishing Dock" title="Fishing Dock" width="30" height="30" style="margin:0 6px;">' +
            '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/PicnicShelter.svg" alt="Picnic Shelter" title="Picnic Shelter" width="30" height="30" style="margin:0 6px;">' +
            '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Waterfowl.svg" alt="Bird Blind" title="Bird Blind" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Fishing Dock, Picnic Shelter, and Bird Blind";
    } 
    else if (adaFacName == "Fishing Dock") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/FishingPier.svg" alt="Fishing Dock" title="Fishing Dock" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Fishing Dock";
    } 
    else if (adaFacName == "Foothills Nature Center") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/ParagliderYes.svg" alt="Foothills Nature Center" title="Foothills Nature Center" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Foothills Nature Center";
    } 
    else if (adaFacName == "Interpretive Signs") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/InterpretiveSign.svg" alt="Interpretive Signs" title="Interpretive Signs" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Interpretive Signs";
    } 
    else if (adaFacName == "Nature Center") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VisitorCenter.svg" alt="Nature Center" title="Nature Center" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Nature Center";
    } 
    else if (adaFacName == "Overlook") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Viewpoint.svg" alt="Scenic Overlook" title="Scenic Overlook" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Scenic Overlook";
    } 
    else if (adaFacName == "Overlook/Fee Station") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Viewpoint.svg" alt="Scenic Overlook and Fee Station" title="Scenic Overlook and Fee Station" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Scenic Overlook and Fee Station";
    } 
    else if (adaFacName == "Ranger Cottage") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/VisitorCenter.svg" alt="Ranger Cottage" title="Ranger Cottage" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Ranger Cottage";
    } 
    else if (adaFacName == "Wood Shelter") {
        adaIconHtml = '<img src="https://raw.githubusercontent.com/trentschlar/SVGs/refs/heads/main/Cabin.svg" alt="Wood Shelter" title="Wood Shelter" width="30" height="30" style="margin:0 6px;">';
        adaAltText = "Wood Shelter";
    } 
    else {
        adaIconHtml = "";
        adaAltText = "";
    }
}

// Add ADA icons to available amenities if present
if (!IsEmpty(adaIconHtml)) {
    availableAmenities += adaIconHtml;
}

// Static Not Allowed icons (fires & hunting)
notAvailableAmenities += '<img src="https://bouldercolorado.gov/media/18166/download?inline" alt="No fires" title="No fires" width="30" height="30" style="margin:0 6px;">';
notAvailableAmenities += '<img src="https://bouldercolorado.gov/media/18169/download?inline" alt="No hunting" title="No hunting" width="30" height="30" style="margin:0 6px;">';

// Ensure accessName is a string
var accessNameStr = IIf(IsEmpty(accessName), "Trailhead", Text(accessName));

var html = 
'<h3 style="background-color:' + statusColor + ';border:1px solid #000;color:white;padding:5px;text-align:center;">' +
    '<span style="font-family:Arial;font-size:18px;">' + accessNameStr + ' Trailhead is ' + trailheadStatus + '</span>' +
'</h3>' +
'<p>' +
    '<img src="' + getParkingIcon(parkSpaces) + '" alt="" width="30" height="30"> &nbsp; &nbsp;' +
    '<span style="font-family:Arial;font-size:14px;">There' + getParkingText(parkSpaces) + ' at ' + accessNameStr + '.' + feeSection + '</span>' +
'</p>' +
'<p>' +
    '<img src="' + getHorseTrailerIcon(horseTrailer) + '" alt="" width="30" height="30"> &nbsp; &nbsp;' +
    '<span style="font-family:Arial;font-size:14px;">Horse trailer parking is ' + horseTrailer + '.</span>' +
'</p>' +
'<h3 style="background-color:#27443A;border:1px solid #000;color:white;padding:5px;text-align:center;">' +
    '<span style="font-family:Arial;font-size:18px;">Available Amenities</span>' +
'</h3>' +
'<p style="text-align:center;">' + availableAmenities + '</p>' +
'<h3 style="background-color:#772618;border:1px solid #000;color:white;padding:5px;text-align:center;">' +
    '<span style="font-family:Arial;font-size:18px;">Not Available</span>' +
'</h3>' +
'<p style="text-align:center;">' + notAvailableAmenities + '</p>' +
'<p>' +
    '<span style="font-family:Arial;font-size:14px;">Find out more on </span>' +
    '<a href="' + thUrl + '" target="_blank" rel="nofollow">' +
        '<span style="font-family:Arial;font-size:14px;">OSMP\'s trailhead web page for ' + accessNameStr + '</span>' +
    '</a>' +
'</p>' +
cameraLink +
closureLink;


return html;

